<div id="widget-container"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<script>
    // Add waitForMarked function definition
    const waitForMarked = () => {
        return new Promise((resolve, reject) => {
            const maxAttempts = 20;
            let attempts = 0;
            
            const check = () => {
                attempts++;
                console.log(`Checking for marked.js (attempt ${attempts})`);
                
                if (window.marked) {
                    console.log('marked.js found');
                    resolve();
                } else if (attempts >= maxAttempts) {
                    reject(new Error('Timeout waiting for marked.js'));
                } else {
                    setTimeout(check, 100);
                }
            };
            
            check();
        });
    };

    (async () => {
        const widgetContainer = document.getElementById('widget-container');
        const timestamp = new Date().getTime();
        const widgetUrl = `https://raw.githubusercontent.com/maceacla/brightspaceMods/refs/heads/main/elec4707w2025/widgetCode/diary-widget.html?t=${timestamp}`;
        
        try {
            console.log('Loading marked.js...');
            await waitForMarked();
            console.log('marked.js loaded');

            const response = await fetch(widgetUrl, { cache: 'no-store' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const widgetHTML = await response.text();
            widgetContainer.innerHTML = widgetHTML;
            console.log('diary-widget.html loaded successfully');
        } catch (error) {
            console.error('Failed to load or render content:', error);
            widgetContainer.innerHTML = '<p>Error loading content</p>';
        }
    })();
</script>